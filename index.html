<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.js"></script>
  <title>D3</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    #svg {
      display: block;
    }

    .links line {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .nodes circle {
      /*stroke: #fff;*/
      /*stroke-width: 1.5px;*/
    }
    .node text {
      pointer-events: none;
      font: 32px sans-serif;
    }

  </style>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <!-- import JavaScript -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>

<div id="app">

  <svg id="svg" style="border: #999999 solid 2px; background: #81D4FA ">
    <defs>
      <pattern id="image" patternUnits="objectBoundingBox" height="64" width="64">
        <image height="24" width="24" xlink:href="./cross.png"/>
      </pattern>

      <pattern id="prim_image" patternUnits="objectBoundingBox" height="64" width="64">
        <image height="46" width="46" xlink:href="./cross.png"/>
      </pattern>

    </defs>
    <defs><marker id="suit" viewBox="0 -5 10 10" refX="29" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5 L10,0 L0, -5" style="stroke: rgb(153, 153, 153); opacity: 0.8;"></path></marker><marker id="licensing" viewBox="0 -5 10 10" refX="29" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5 L10,0 L0, -5" style="stroke: rgb(153, 153, 153); opacity: 0.8;"></path></marker><marker id="resolved" viewBox="0 -5 10 10" refX="29" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5 L10,0 L0, -5" style="stroke: rgb(153, 153, 153); opacity: 0.8;"></path></marker></defs>
  </svg>
</div>


<script>

  let app = new Vue({
    el: '#app',
    data: function () {
      return {

        message: 'hello',
        param: 0,

      }
    },
  });


  // localStorage.removeItem('nodes_data');
  // localStorage.removeItem('links_data');
  let nodes_data = JSON.parse(localStorage.getItem('nodes_data'))||[{'info': 'prim_add'}];
  let links_data = JSON.parse(localStorage.getItem('links_data'))||[];

  let radius = 24;
  let width = document.documentElement.clientWidth-4;
  let height = document.documentElement.clientHeight-4;

  (function() {
    let throttle = function(type, name, obj) {
      obj = obj || window;
      let running = false;
      let func = function() {
        if (running) { return; }
        running = true;
        requestAnimationFrame(function() {
          obj.dispatchEvent(new CustomEvent(name));
          running = false;
        });
      };
      obj.addEventListener(type, func);
    };
    throttle("resize", "optimizedResize");
  })();

  window.addEventListener("optimizedResize", function (e) {
    width = e.target.document.documentElement.clientWidth-4;
    height = e.target.document.documentElement.clientHeight-4;
  });

  function tickActions() {
    node.filter((d)=>{if(d.info!=='add'){return d}})
        .attr("cx", function (d) { return d.x = Math.max(radius, Math.min(width - radius, d.x))})
        .attr("cy", function (d) { return d.y = Math.max(radius, Math.min(height - radius, d.y));});

    node.filter((d)=>{if(d.info==='add'){return d}})
        .attr("cx", function (d) {
          return d.x;
        })
        .attr("cy", function (d) {
          return d.y;
        });

    link
        .attr("x1", function (d) {
          return d.source.x;
        })
        .attr("y1", function (d) {
          return d.source.y;
        })
        .attr("x2", function (d) {
          return d.target.x;
        })
        .attr("y2", function (d) {
          return d.target.y;
        });

    text
        .attr("x", function (d) {return d.x;})
        .attr("y", function (d) {return d.y;});

      svg.style('height',height);
      svg.style('width',width);
  }

  let svg = d3.select("svg");
  let simulation = d3.forceSimulation();
  let g = svg.append("g").attr("class", "everything").style('border', "solid black 7px");
  let link = g.append("g").attr("class", "links").selectAll("line");
  let node = g.append("g").attr("class", "nodes").selectAll("circle");
  let text = g.append('g').attr("class", "texts").selectAll('text');

  simulation
      .force("charge_force", d3.forceManyBody().strength(-80).theta(0.5))
      .force("center_force1", d3.forceX().strength(0.02).x(window.innerWidth / 2))
      .force("links", d3.forceLink())
      .force("center_force2", d3.forceY().strength(0.02).y(window.innerHeight / 2))
      .on("tick", tickActions);


  function Node(index, info, text, fixed, x,y) {
    this.index = index;
    this.info = info;
    this.text = text;
    this.fixed = fixed;
    this.fx=x;
    this.fy=y;
    this.vx=null;
    this.vy=null;
  }
  function Link(index, source, target) {
    this.index=index;
    this.source= source.index;
    this.target= target.index;
  }


  function restart() {
    text = text.data(nodes_data, d=>{return d.index;});
    text.exit().remove();
    text = text.enter().append('text').merge(text);

    text
        .text(node => {if (node.info==='node'){return node.text.slice(0,6)}})
        .attr('font-family', "sans-serif")
        .attr('font-size', 10)
        .attr('text-anchor', "middle");

    node = node.data(nodes_data, d=>{ return d.index;});
    node.exit().remove();
    node = node.enter().append("circle").merge(node);

    node.filter((d)=>{if (d.info==='node') {return d}})
        .attr('fill', '#64FFDA')
        .attr("r", radius)
        .attr('stroke-width',(d)=>{if(d.fixed){return 4} else return 0})
        .attr('stroke','#7B1FA2')
        .attr('stroke-opacity',"0.3")
        .on("dblclick", releasenode);

    node.filter((d)=>{if (d.info === 'add') {return d}})
        .attr('fill', 'url(#image)')
        .attr("r", 12)
        .attr('stroke-width','0')
        .attr('stroke','white')
        .on("dblclick", mcd);

    node.filter((d)=>{if (d.info === 'prim_add') {return d}})
        .attr('fill', 'url(#prim_image)')
        .attr("r", radius)
        .on("dblclick", prim_mcd);




    link = link.data(links_data, function (d) { return d.source.index+'-'+d.target.index;});
    link.exit().remove();
    link = link.enter().append("line").attr("stroke-width", 2).style("marker-end",d=>{if (d.target.info==='node'){return "url(#suit)"}}).merge(link);


    simulation.nodes(nodes_data);
    simulation.force("links").links(links_data).id((d,r)=>{return d.index}).iterations(8).distance(function (d) {
      if (d.target.info==='node'){return 120}
      else {return 21}
    });
    simulation.alpha(0.01).restart();
    (d3.drag()
        .on("start", dragstart)
        .on("drag", dragmove)
        .on("end", dragend))(node);

    (d3.zoom()
        .translateExtent([[0,0],[width,height]])
        .scaleExtent([1,3])
        .filter(()=>{if(d3.event.type!=="mousedown" && d3.event.type!=="dblclick"  ){return true}})
        .on("zoom", ()=>{
          g.attr("transform", d3.event.transform)
        }))(svg);

    let nds = [];
    for (let elem of nodes_data){
      nds.push(new Node(elem.index,elem.info,elem.text,elem.fixed,elem.fx,elem.fy))
    }
    let lds = [];
    for (let lnk of links_data){
      lds.push(new Link(lnk.index,lnk.source,lnk.target))
    }
    localStorage.setItem('nodes_data', JSON.stringify(nds));
    localStorage.setItem('links_data', JSON.stringify(lds));

  }

  function prim_mcd(snode) {

    let res = prompt();
    if (res) {
      snode.fixed = false;
      let point = d3.mouse(this),
          node = {x: point[0], y: point[1], info: 'node', text: res},
          nodeAdd = {x: point[0], y: point[1], info: 'add'},
          n = nodes_data.push(node),
          node_a = nodes_data.push(nodeAdd);

      links_data.push({"source": n-1, "target": node_a-1});
    }
    event.stopPropagation();
    restart();
    console.log(links_data);

  }

  function mcd(snode) {
    snode.fixed = false;
    let res = prompt();
    if (res) {
      let point = d3.mouse(this),
          node = {x: point[0], y: point[1], info: 'node', text: res},
          nodeAdd = {x: point[0], y: point[1], info: 'add'},
          n = nodes_data.push(node),
          node_a = nodes_data.push(nodeAdd);
      links_data.push({"source": snode.index - 1, "target": n-1});
      links_data.push({"source": n-1, "target": node_a-1});
    }
    event.stopPropagation();
    restart();
  }

  function dragstart(d) {
    if (!d3.event.active) simulation.alphaTarget(0).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragmove(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragend(d) {
    if( d.info ==='node'){
      d.fixed = true;
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }
    else {
      d.fx = null;
      d.fy = null;
    }
    if (!d3.event.active) simulation.alphaTarget(0);
  }

  function releasenode(d) {
    d.fixed = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
    event.stopPropagation();
  }

  setInterval(restart, 100);



</script>
</body>
</html>