<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.js"></script>
  <title>D3</title>
  <style>

    .links line {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .nodes circle {
      stroke: #fff;
      stroke-width: 1.5px;
    }

  </style>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <!-- import JavaScript -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>

<div id="app">

  <svg id="svg" height="1024" width="1920">
    <defs>
      <pattern id="image" patternUnits="objectBoundingBox" height="64" width="64">
        <image height="30" width="30" xlink:href="./cross.png"/>
      </pattern>
    </defs>
  </svg>
</div>


<script>

  let app = new Vue({
    el: '#app',
    data: function () {
      return {

        message: 'hello',
        param: 0,

      }
    },
  });

  let nodes_data = [
    {'info': true},
    {'info': false},
  ];
  let links_data = [];

  function tickActions() {
    //update circle positions to reflect node updates on each tick of the simulation
    node
        .attr("cx", function (d) {
          return d.x;
        })
        .attr("cy", function (d) {
          return d.y;
        });

    link
        .attr("x1", function (d) {
          return d.source.x;
        })
        .attr("y1", function (d) {
          return d.source.y;
        })
        .attr("x2", function (d) {
          return d.target.x;
        })
        .attr("y2", function (d) {
          return d.target.y;
        });

  }

  let svg = d3.select("svg").attr('width', 1920||window.innerWidth).attr("height", 1024 || window.innerHeight);
  svg.append("defs").selectAll("marker")
      .data(["suit", "licensing", "resolved"])
      .enter().append("marker")
      .attr("id", d=> {return d;})
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 29)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5 L10,0 L0, -5")
      .style("stroke", "#999")
      .style("opacity", "0.8");
  let simulation = d3.forceSimulation();

  simulation
      .force("charge_force", d3.forceManyBody().strength(-200))
      .force("center_force1", d3.forceX().strength(0.02).x(window.innerWidth / 2))
      .force("center_force2", d3.forceY().strength(0.02).y(window.innerHeight / 2))
      .force("links", d3.forceLink(links_data).distance(120))
      .on("tick", tickActions);

  let link = svg.append("g").attr("class", "links").selectAll("line");

  let node = svg.append("g").attr("class", "nodes").selectAll("circle");

  restart();

  function restart() {
    node = node.data(nodes_data, d=>{return d.index;});
    node.exit().remove();
    node = node.enter()
        .append("circle")
        .merge(node);

    node.filter((d)=>{if (d.info) {return d}})
        .attr('fill', '#e24b32')
        .attr("r", 23)
        .on("dblclick", releasenode);

    node.filter((d)=>{if (!d.info) {return d}})
        .attr('fill', 'url(#image)')
        .attr("r", 15)
        .on("dblclick", mcd);


    // Apply the general update pattern to the links.
    link = link.data(links_data, function (d) {
      return d.source.id + "-" + d.target.id;
    });
    link.exit().remove();
    link = link.enter().append("line").attr("stroke-width", 2).style("marker-end",d=>{if (d.target.info){return "url(#suit)"}}).merge(link);

    // Update and restart the simulation.
    simulation.nodes(nodes_data);
    simulation.force("links").links(links_data);
    simulation.alpha(1).restart();
    (d3.drag()
        .on("start", dragstart)
        .on("drag", dragmove)
        .on("end", dragend))(node);
  }

  function mcd(event) {
    event.info = true;
    event.fixed = false;
    let point = d3.mouse(this),
        node = {x: point[0], y: point[1], info: true},
        add = {x: point[0], y: point[1], info: false},
        n = nodes_data.push(node),
        n_add = nodes_data.push(add);
    links_data.push({"source": event, "target": node});
    links_data.push({"source": event, "target": add});
    restart();
  }

  function dragstart(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragmove(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragend(d) {
    if( d.info){
      d.fixed = true;
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }
    else {
      d.fx = null;
      d.fy = null;
    }
    if (!d3.event.active) simulation.alphaTarget(0);
  }

  function releasenode(d) {
    d.fixed = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
    event.stopPropagation();
  }


</script>
</body>
</html>